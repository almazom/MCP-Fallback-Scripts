# Configuration

<cite>
**Referenced Files in This Document**   
- [telegram_manager.sh](file://telegram_manager.sh)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py)
- [tests/test_10_error_handling.sh](file://tests/test_10_error_handling.sh)
</cite>

## Table of Contents
1. [Configuration Overview](#configuration-overview)
2. [Environment Variables](#environment-variables)
3. [Generating and Securing Credentials](#generating-and-securing-credentials)
4. [Configuration Loading Mechanism](#configuration-loading-mechanism)
5. [Security Considerations](#security-considerations)
6. [Multi-Environment Configuration Management](#multi-environment-configuration-management)
7. [Error Handling and Diagnostics](#error-handling-and-diagnostics)

## Configuration Overview

The system uses a `.env` file located in the project root to store sensitive credentials and runtime configuration. This file is critical for authenticating with the Telegram API and maintaining session persistence across script executions. The configuration system is designed to be simple, secure, and consistent across both Bash and Python components of the application.

The `.env` file follows standard environment variable syntax with `KEY=VALUE` pairs, one per line, and supports quoted values. Comments are allowed using the `#` symbol. This centralized configuration approach ensures that sensitive data is not hardcoded in scripts and can be easily managed across different deployment environments.

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L36-L38)

## Environment Variables

The system relies on three essential configuration variables stored in the `.env` file:

**:TELEGRAM_API_ID**
- **Purpose**: Unique identifier assigned by Telegram when creating a Telegram API project
- **Format Requirements**: Positive integer (e.g., 1234567)
- **Source**: Obtained from https://my.telegram.org/apps after creating a new application
- **Security Level**: Sensitive - should not be exposed publicly

**:TELEGM_API_HASH**
- **Purpose**: Secret hash key associated with the API ID for authentication
- **Format Requirements**: 32-character hexadecimal string (e.g., "a1b2c3d4e5f678901234567890abcdef")
- **Source**: Generated automatically when creating a Telegram API project
- **Security Level**: Highly sensitive - must be kept confidential
- **Note**: There appears to be a typo in the variable name (`TELEGM_API_HASH` instead of `TELEGRAM_API_HASH`) that may require correction in the codebase

**:TELEGRAM_SESSION**
- **Purpose**: Encoded session string that maintains login state with Telegram
- **Format Requirements**: Base64-encoded string generated by Telethon's StringSession
- **Source**: Automatically generated during first authentication or manually created
- **Security Level**: Highly sensitive - equivalent to account credentials

These variables are loaded by both Bash scripts and Python modules through direct file parsing, avoiding reliance on the system's environment variables to prevent accidental exposure.

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L30-L40)

## Generating and Securing Credentials

To generate the required configuration values:

1. **Obtain API ID and Hash**:
   - Visit https://my.telegram.org/apps
   - Log in with your Telegram account
   - Create a new application
   - Copy the generated API_ID (integer) and API_HASH (32-character string)
   - Store these values securely

2. **Generate Session String**:
   - The session string is automatically created when first connecting to Telegram
   - Alternatively, use Telethon's interactive session creation:
   ```python
   from telethon.sync import TelegramClient
   from telethon.sessions import StringSession
   print(StringSession().save())
   ```
   - This generates a secure, encoded string representing your authenticated session

3. **Create .env File**:
   ```
   TELEGRAM_API_ID=1234567
   TELEGM_API_HASH=a1b2c3d4e5f678901234567890abcdef
   TELEGRAM_SESSION=your-generated-session-string
   ```

4. **Secure Storage**:
   - Set file permissions to 600: `chmod 600 .env`
   - Add `.env` to `.gitignore` to prevent accidental commits
   - Never share the `.env` file or its contents
   - Consider using a password manager for backup

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L30-L40)

## Configuration Loading Mechanism

The configuration system is implemented consistently across both Bash and Python components:

**:Bash Script Loading (telegram_manager.sh)**
- The `send` command reads the `.env` file directly using a Python inline script
- Each line is parsed, skipping comments and empty lines
- Key-value pairs are extracted by splitting on the first `=` character
- Values are stripped of surrounding quotes
- Credentials are stored in a dictionary for use in TelegramClient initialization

**:Python Module Loading (telegram_fetch.py)**
- The `fetch_and_cache` function loads credentials from the `.env` file
- File path is constructed relative to the script location
- Line-by-line parsing with comment filtering
- String values are stripped of quotes before use
- Integer conversion is applied to TELEGRAM_API_ID
- Credentials are used to initialize TelegramClient with StringSession

Both implementations follow the same parsing logic, ensuring consistency across the application. The relative path resolution allows the system to work regardless of the current working directory.

```mermaid
flowchart TD
Start([Configuration Load]) --> ReadFile["Read .env file"]
ReadFile --> ParseLine["Parse each line"]
ParseLine --> IsComment{"Line starts with #?"}
IsComment --> |Yes| SkipLine["Skip line"]
IsComment --> |No| HasEquals{"Contains =?"}
HasEquals --> |No| SkipLine
HasEquals --> |Yes| ExtractKV["Extract key=value"]
ExtractKV --> StripQuotes["Strip surrounding quotes"]
StripQuotes --> Store["Store in credentials dict"]
Store --> NextLine["Process next line"]
NextLine --> EndLoop["End of file?"]
EndLoop --> |No| ParseLine
EndLoop --> |Yes| ReturnCreds["Return credentials"]
SkipLine --> NextLine
```

**Diagram sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L30-L40)

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L30-L40)

## Security Considerations

The configuration system implements several security measures:

**:File Permissions**
- The `.env` file should have restrictive permissions (600)
- Prevents unauthorized read access by other users on the system
- Set with: `chmod 600 .env`

**:Environment Variable Exposure**
- Credentials are read directly from file rather than environment variables
- Reduces risk of exposure through process lists or logs
- Avoids potential leakage to child processes

**:Session Management**
- Session strings should be treated as passwords
- Regular rotation recommended for security
- Invalid sessions will require re-authentication
- Multiple sessions can coexist for different purposes

**:Input Sanitization**
- All configuration values are properly quoted and escaped
- Prevents injection attacks
- Channel names and other user inputs are validated

**:Error Handling**
- Authentication errors provide clear but non-specific messages
- Prevents information leakage about valid vs. invalid credentials
- Missing configuration variables are detected early

**:Best Practices**
- Never commit `.env` files to version control
- Use different API credentials for different environments
- Regularly audit and rotate credentials
- Monitor for unauthorized access attempts
- Backup credentials securely

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [tests/test_10_error_handling.sh](file://tests/test_10_error_handling.sh#L72)

## Multi-Environment Configuration Management

For managing configurations across different environments:

**:Environment-Specific Files**
- Use different `.env` files for development, testing, and production
- Examples: `.env.dev`, `.env.prod`
- Switch files based on environment variables or script parameters

**:Configuration Validation**
- Implement validation checks for all required variables
- Verify format requirements (integer for API_ID, proper hash length)
- Test connectivity during startup

**:Secure Distribution**
- Use encrypted storage for backup configurations
- Distribute credentials through secure channels
- Consider using secret management tools for team environments

**:Version Control Strategy**
- Keep a `.env.example` file in version control
- This file contains template with placeholder values
- Documents required variables without exposing secrets
- Team members copy and fill in their own values

**:Testing Environment**
- Use separate Telegram API credentials for testing
- Isolate test sessions from production
- Automate credential setup in CI/CD pipelines

**Section sources**
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)
- [scripts/telegram_tools/core/telegram_fetch.py](file://scripts/telegram_tools/core/telegram_fetch.py#L30-L40)

## Error Handling and Diagnostics

The system implements comprehensive error handling for configuration issues:

**:Missing Configuration Detection**
- Scripts check for the presence of required variables
- Clear error messages identify missing variables
- Example: "Error: Missing required variable: TELEGRAM_API_ID"
- Testing script validates this behavior (test_10_error_handling.sh)

**:Validation and Diagnostics**
- Type conversion errors are caught and reported
- File access permissions are verified
- Malformed configuration entries are detected
- Detailed error messages help diagnose issues

**:Testing and Verification**
- Comprehensive test suite covers configuration error scenarios
- Tests validate missing variables, invalid formats, and edge cases
- Error messages are verified for accuracy and security
- Input sanitization is tested against injection attempts

**:Troubleshooting Guide**
1. Check `.env` file exists in project root
2. Verify file permissions are set to 600
3. Ensure all required variables are present
4. Validate format of API_ID (integer) and API_HASH (32-character string)
5. Test configuration with simple command: `./telegram_manager.sh cache`
6. Check error logs for specific error messages

The error handling system provides actionable feedback while maintaining security by not revealing sensitive information about the nature of authentication failures.

```mermaid
flowchart TD
Start([Configuration Error]) --> CheckFile["Check .env file exists"]
CheckFile --> |Missing| Error1["Error: File not found"]
CheckFile --> |Exists| ReadFile["Attempt to read file"]
ReadFile --> |Permission Denied| Error2["Error: Permission denied"]
ReadFile --> |Success| ParseFile["Parse configuration"]
ParseFile --> MissingVar{"Required variable missing?"}
MissingVar --> |Yes| Error3["Error: Missing required variable"]
MissingVar --> |No| ValidateFormat["Validate format"]
ValidateFormat --> InvalidFormat{"Format invalid?"}
InvalidFormat --> |Yes| Error4["Error: Invalid format"]
InvalidFormat --> |No| Connection["Attempt connection"]
Connection --> AuthFail{"Authentication failed?"}
AuthFail --> |Yes| Error5["Error: Authentication failed"]
AuthFail --> |No| Success["Success"]
Error1 --> End
Error2 --> End
Error3 --> End
Error4 --> End
Error5 --> End
Success --> End
```

**Diagram sources**
- [tests/test_10_error_handling.sh](file://tests/test_10_error_handling.sh#L72)
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)

**Section sources**
- [tests/test_10_error_handling.sh](file://tests/test_10_error_handling.sh#L41-L79)
- [telegram_manager.sh](file://telegram_manager.sh#L65-L66)